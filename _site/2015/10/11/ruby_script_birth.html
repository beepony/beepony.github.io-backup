<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>记一个小脚本的编写过程</title><meta name="twitter:card" content="summary" /><meta name="twitter:site" content="@beepony" /><meta name="twitter:title" content="记一个小脚本的编写过程" /><meta name="twitter:description" content="最近接到一个需求，将绑定在我司的域名解析出对应的空间，主要设计到对字符串处理，于是用学到的一点点 Ruby 知识写了个脚本。"><meta name="description" content="最近接到一个需求，将绑定在我司的域名解析出对应的空间，主要设计到对字符串处理，于是用学到的一点点 Ruby 知识写了个脚本。"><link rel="icon" href="/assets/favicon.png"><link rel="apple-touch-icon" href="/assets/touch-icon.png"><link rel="stylesheet" href="//code.cdn.mozilla.net/fonts/fira.css"><link rel="stylesheet" href="/assets/core.css"><link rel="canonical" href="/2015/10/11/ruby_script_birth.html"><link rel="alternate" type="application/atom+xml" title="beepony" href="/feed.xml" /></head><body><aside class="logo"> <a href="/"> <img src="http://beepony.b0.upaiyun.com/blog/avatar/avatar.png" class="gravatar"> </a> <span class="logo-prompt">Back to Home</span></aside><main> <noscript><style> article .footnotes { display: block; }</style></noscript><article><div class="center"><h1>记一个小脚本的编写过程</h1><time>October 11, 2015</time></div><div class="divider"></div><p>最近接到一个需求，将绑定在我司的域名解析出对应的空间，主要设计到对字符串处理，于是用学到的一点点 Ruby 知识写了个脚本。</p><div class="language-ruby highlighter-coderay"><div class="CodeRay"><div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span><span style="color:#777"># /usr/bin/ruby -w</span>
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span><span style="color:#777"># coding:utf-8</span>
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span><span style="color:#777"># dig the domain and bucket</span>
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span><span style="color:#777"># https://github.com/bluemonk/net-dns</span>
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span>
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span>require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">net/dns</span><span style="color:#710">'</span></span>
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span>require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">json</span><span style="color:#710">'</span></span>
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span>
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span><span style="color:#777"># 将给定的 url dig 出来 answer 里的第一条解析记录</span>
<span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span><span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">dig_dns</span>(url)
<span class="line-numbers"><a href="#n11" name="n11">11</a></span>  packet = <span style="color:#036;font-weight:bold">Net</span>::<span style="color:#036;font-weight:bold">DNS</span>::<span style="color:#036;font-weight:bold">Resolver</span>.start(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>url<span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">&quot;</span></span>)
<span class="line-numbers"><a href="#n12" name="n12">12</a></span>  r = packet.answer[<span style="color:#00D">0</span>].to_s.split(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20"> </span><span style="color:#710">&quot;</span></span>)
<span class="line-numbers"><a href="#n13" name="n13">13</a></span>  print <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>r[<span style="color:#00D">0</span>].to_s.chop<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">  </span><span style="color:#710">&quot;</span></span> <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>r[<span style="color:#00D">4</span>].to_s.split(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">.</span><span style="color:#710">&quot;</span></span>)[<span style="color:#00D">0</span>]<span style="font-weight:bold;color:#666">}</span></span><span style="color:#b0b">\n</span><span style="color:#710">&quot;</span></span>
<span class="line-numbers"><a href="#n14" name="n14">14</a></span><span style="color:#080;font-weight:bold">end</span>
<span class="line-numbers"><a href="#n15" name="n15">15</a></span>
<span class="line-numbers"><a href="#n16" name="n16">16</a></span><span style="color:#777"># 将泛域名里面的 * 替换成 test，以符合域名解析规则</span>
<span class="line-numbers"><a href="#n17" name="n17">17</a></span><span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">subt</span>(str)
<span class="line-numbers"><a href="#n18" name="n18">18</a></span>        <span style="color:#080;font-weight:bold">if</span> str.include? <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">*</span><span style="color:#710">'</span></span>
<span class="line-numbers"><a href="#n19" name="n19">19</a></span>                str.sub(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">*</span><span style="color:#710">'</span></span>,<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">upyun</span><span style="color:#710">'</span></span>)
<span class="line-numbers"><strong><a href="#n20" name="n20">20</a></strong></span>        <span style="color:#080;font-weight:bold">else</span>
<span class="line-numbers"><a href="#n21" name="n21">21</a></span>                str
<span class="line-numbers"><a href="#n22" name="n22">22</a></span>        <span style="color:#080;font-weight:bold">end</span>
<span class="line-numbers"><a href="#n23" name="n23">23</a></span><span style="color:#080;font-weight:bold">end</span>
<span class="line-numbers"><a href="#n24" name="n24">24</a></span>
<span class="line-numbers"><a href="#n25" name="n25">25</a></span><span style="color:#777"># 包含域名的文件作为参数输入</span>
<span class="line-numbers"><a href="#n26" name="n26">26</a></span><span style="color:#777"># filename = ARGV[0]</span>
<span class="line-numbers"><a href="#n27" name="n27">27</a></span>filename = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">yuming.txt</span><span style="color:#710">'</span></span>
<span class="line-numbers"><a href="#n28" name="n28">28</a></span><span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">afile</span>(filename)
<span class="line-numbers"><a href="#n29" name="n29">29</a></span>        <span style="color:#036;font-weight:bold">File</span>.open(filename,<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">r</span><span style="color:#710">'</span></span>) <span style="color:#080;font-weight:bold">do</span> |f|
<span class="line-numbers"><strong><a href="#n30" name="n30">30</a></strong></span>                f.each <span style="color:#080;font-weight:bold">do</span> |line|
<span class="line-numbers"><a href="#n31" name="n31">31</a></span>                        line.split(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20"> </span><span style="color:#710">'</span></span>).each {|s|
<span class="line-numbers"><a href="#n32" name="n32">32</a></span>                                dig_dns(subt(s)) 
<span class="line-numbers"><a href="#n33" name="n33">33</a></span>                        }
<span class="line-numbers"><a href="#n34" name="n34">34</a></span>                <span style="color:#080;font-weight:bold">end</span>
<span class="line-numbers"><a href="#n35" name="n35">35</a></span>        <span style="color:#080;font-weight:bold">end</span>
<span class="line-numbers"><a href="#n36" name="n36">36</a></span><span style="color:#080;font-weight:bold">end</span>
<span class="line-numbers"><a href="#n37" name="n37">37</a></span>
<span class="line-numbers"><a href="#n38" name="n38">38</a></span>afile(filename)
</pre></div></div></div></article><div class="back"> <a href="/">Back</a></div></main></body></html>